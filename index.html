<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상담 예약 시스템</title>
    <!-- Firebase SDK 로드 -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Malgun Gothic', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background-color: #f4f4f4; }
        .container { width: 90%; max-width: 550px; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.1); }
        h1, h2, h3 { text-align: center; color: #333; }

        /* ======== 1. 시작 화면 (로그인) 스타일 ======== */
        #login-view { text-align: center; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 12px; font-size: 1em; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        #enter-btn { width: 100%; padding: 15px; font-size: 1.1em; font-weight: bold; color: white; background-color: #007bff; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; }
        #enter-btn:hover { background-color: #0056b3; }

        /* ======== 2. 예약 화면 스타일 ======== */
        #reservation-view { display: none; }
        #back-btn { padding: 8px 15px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 20px; }
        .day-tabs { display: flex; justify-content: space-around; margin-bottom: 20px; border-bottom: 2px solid #dee2e6; }
        .day-tab { padding: 10px 15px; font-size: 1.1em; font-weight: bold; border: none; background: none; cursor: pointer; color: #495057; }
        .day-tab.active { color: #007bff; border-bottom: 2px solid #007bff; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: center; }
        th { background-color: #f2f2f2; }
        .time-slot { cursor: pointer; background-color: #e7f3ff; color: #0056b3; font-weight: bold; }
        .time-slot:hover { background-color: #d0e7ff; }
        .booked { background-color: #e9ecef; color: #6c757d; cursor: not-allowed; font-weight: normal; }
        /* 본인 예약 취소 버튼 스타일 */
        .cancel-btn { padding: 8px 12px; font-size: 0.9em; background-color: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .cancel-btn:hover { background-color: #c82333; }

        /* ======== 3. 커스텀 모달(입력창) 스타일 ======== */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-box { background: #fff; padding: 25px; border-radius: 10px; width: 90%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center; }
        .modal-box h3 { margin-top: 0; }
    </style>
</head>
<body>

<div class="container">
    <!-- ======== 1. 시작 화면 (로그인) ======== -->
    <div id="login-view">
        <h1>상담 예약</h1>
        <div class="form-group">
            <label for="name-input">이름</label>
            <input type="text" id="name-input" placeholder="성함을 입력하세요">
        </div>
        <div class="form-group">
            <label for="class-select">반 선택</label>
            <select id="class-select">
                <!-- 반 목록이 동적으로 추가됩니다 -->
            </select>
        </div>
        <button id="enter-btn">예약 페이지로 이동</button>
    </div>

    <!-- ======== 2. 예약 화면 ======== -->
    <div id="reservation-view">
        <button id="back-btn">&larr; 처음으로</button>
        <h2 id="reservation-title"></h2>
        <div class="day-tabs" id="day-tabs-container"></div>
        <table id="reservation-table">
            <thead>
                <tr>
                    <th>시간</th>
                    <th>예약 상태</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function () {
    const firebaseConfig = {
        apiKey: "AIzaSyAYAWnTBTIa4aEsNFrKhRicSfLz9wv58Ew",
        authDomain: "bcs-parent-teacher-conference.firebaseapp.com",
        projectId: "bcs-parent-teacher-conference",
        storageBucket: "bcs-parent-teacher-conference.firebasestorage.app",
        messagingSenderId: "265252330101",
        appId: "1:265252330101:web:749b8ee8ab9de7d102363c"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // DOM 요소
    const loginView = document.getElementById('login-view');
    const reservationView = document.getElementById('reservation-view');
    const nameInput = document.getElementById('name-input');
    const classSelect = document.getElementById('class-select');
    const enterBtn = document.getElementById('enter-btn');
    const backButton = document.getElementById('back-btn');
    const reservationTitle = document.getElementById('reservation-title');
    const dayTabsContainer = document.getElementById('day-tabs-container');
    const tableBody = document.querySelector('#reservation-table tbody');

    // 데이터 및 설정
    const classNames = ["희락반", "자비반", "양선반", "충성반", "온유반", "은혜반"];
    const dayNames = ["월", "화", "수", "목", "금"];
    const startTime = 17 * 60;
    const endTime = 20 * 60;
    const interval = 30;
    
    // 현재 사용자 정보를 저장할 변수
    let currentUserName = '';
    let currentClass = '';
    let currentDay = '';

    // 1. 시작 화면 초기화
    function initializeLoginView() {
        // 드롭다운에 반 목록 채우기
        classNames.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            classSelect.appendChild(option);
        });
        
        // '들어가기' 버튼 이벤트
        enterBtn.addEventListener('click', () => {
            const name = nameInput.value.trim();
            const selectedClass = classSelect.value;
            if (!name) {
                alert('이름을 입력해주세요.');
                return;
            }
            currentUserName = name;
            showReservationView(selectedClass);
        });
        
        // '처음으로' 버튼 이벤트
        backButton.addEventListener('click', showLoginView);
    }

    // 2. 예약 화면 표시
    function showReservationView(className) {
        currentClass = className;
        currentDay = dayNames[0]; // 기본 '월'요일
        loginView.style.display = 'none';
        reservationView.style.display = 'block';
        reservationTitle.textContent = `${currentClass} (${currentUserName}님)`; // 제목에 이름 표시
        generateDayTabs();
        generateReservationTable();
    }
    
    // 3. 시작 화면으로 돌아가기
    function showLoginView() {
        reservationView.style.display = 'none';
        loginView.style.display = 'block';
        currentUserName = ''; // 사용자 이름 초기화
    }

    // 4. 요일 탭 생성 (변경 없음)
    function generateDayTabs() {
        dayTabsContainer.innerHTML = '';
        dayNames.forEach(dayName => {
            const tab = document.createElement('button');
            tab.className = 'day-tab';
            tab.textContent = dayName;
            if (dayName === currentDay) tab.classList.add('active');
            tab.addEventListener('click', () => {
                currentDay = dayName;
                document.querySelectorAll('.day-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                generateReservationTable();
            });
            dayTabsContainer.appendChild(tab);
        });
    }

    // 5. 예약 테이블 생성 (삭제 기능 추가)
    async function generateReservationTable() {
        tableBody.innerHTML = '<tr><td colspan="2">예약 정보를 불러오는 중...</td></tr>';
        const docId = `${currentClass}_${currentDay}`;
        const docRef = db.collection("reservations").doc(docId);
        const docSnap = await docRef.get();
        const reservationData = docSnap.exists ? docSnap.data() : {};
        tableBody.innerHTML = '';

        for (let time = startTime; time < endTime; time += interval) {
            const row = document.createElement('tr');
            const timeCell = document.createElement('td');
            const statusCell = document.createElement('td');
            const timeString = `${String(Math.floor(time/60)).padStart(2,'0')}:${String(time%60).padStart(2,'0')}`;
            timeCell.textContent = `${timeString} - ${String(Math.floor((time+interval)/60)).padStart(2,'0')}:${String((time+interval)%60).padStart(2,'0')}`;

            const bookedName = reservationData[timeString];

            if (bookedName) {
                if (bookedName === currentUserName) {
                    // 본인 예약인 경우 -> 취소 버튼 표시
                    statusCell.innerHTML = `(본인 예약) <button class="cancel-btn">취소하기</button>`;
                    statusCell.querySelector('.cancel-btn').addEventListener('click', () => cancelBooking(timeString));
                } else {
                    // 다른 사람 예약인 경우
                    statusCell.textContent = `${bookedName} (예약 완료)`;
                    statusCell.classList.add('booked');
                }
            } else {
                // 예약 가능 슬롯
                statusCell.textContent = '예약하기';
                statusCell.classList.add('time-slot');
                statusCell.addEventListener('click', () => bookSlot(timeString));
            }
            row.appendChild(timeCell); row.appendChild(statusCell); tableBody.appendChild(row);
        }
    }

    // 6. 예약 기능
    async function bookSlot(timeString) {
        // 예약 시에는 현재 로그인된 사용자 이름(currentUserName)을 사용
        const name = currentUserName;
        const docId = `${currentClass}_${currentDay}`;
        const docRef = db.collection("reservations").doc(docId);
        try {
            await docRef.set({ [timeString]: name }, { merge: true });
            alert('예약이 완료되었습니다.');
            generateReservationTable();
        } catch (error) {
            console.error("예약 오류: ", error);
            alert("예약에 실패했습니다.");
        }
    }
    
    // 7. 예약 취소 기능 (신규 추가)
    async function cancelBooking(timeString) {
        if (!confirm('정말로 이 예약을 취소하시겠습니까?')) {
            return;
        }
        
        const docId = `${currentClass}_${currentDay}`;
        const docRef = db.collection("reservations").doc(docId);
        
        // Firestore에서 특정 필드를 삭제하기 위한 특별한 값
        const FieldValue = firebase.firestore.FieldValue;

        try {
            await docRef.update({
                [timeString]: FieldValue.delete()
            });
            alert('예약이 취소되었습니다.');
            generateReservationTable(); // 테이블 새로고침
        } catch (error) {
            console.error("예약 취소 오류: ", error);
            alert("예약 취소에 실패했습니다.");
        }
    }

    // 페이지 로드 시 시작 화면 초기화
    initializeLoginView();
});
</script>

</body>
</html>
