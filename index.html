<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>반별/요일별 상담 예약 (Firebase 연동)</title>
    <!-- 1. Firebase 라이브러리 추가 -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        /* CSS 스타일은 이전과 동일합니다. */
        body { font-family: 'Malgun Gothic', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background-color: #f4f4f4; }
        .container { width: 90%; max-width: 550px; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.1); }
        h1, h2 { text-align: center; color: #333; }
        #class-selection-view { text-align: center; }
        .class-button-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .class-btn { padding: 20px; font-size: 1.2em; font-weight: bold; color: #fff; background-color: #007bff; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.3s; }
        .class-btn:hover { background-color: #0056b3; }
        #reservation-view { display: none; }
        #back-btn { padding: 8px 15px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 20px; }
        #back-btn:hover { background-color: #5a6268; }
        .day-tabs { display: flex; justify-content: space-around; margin-bottom: 20px; border-bottom: 2px solid #dee2e6; }
        .day-tab { padding: 10px 15px; font-size: 1.1em; font-weight: bold; border: none; background: none; cursor: pointer; color: #495057; border-bottom: 2px solid transparent; }
        .day-tab.active { color: #007bff; border-bottom-color: #007bff; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: center; }
        th { background-color: #f2f2f2; }
        .time-slot { cursor: pointer; background-color: #e7f3ff; color: #0056b3; font-weight: bold; }
        .time-slot:hover { background-color: #d0e7ff; }
        .booked { background-color: #e9ecef; color: #6c757d; cursor: not-allowed; font-weight: normal; }
    </style>
</head>
<body>

<div class="container">
    <div id="class-selection-view">
        <h1>상담 예약</h1>
        <h2>상담을 원하는 반을 선택해주세요.</h2>
        <div class="class-button-container" id="class-buttons"></div>
    </div>
    <div id="reservation-view">
        <button id="back-btn">&larr; 반 선택 화면으로</button>
        <h2 id="reservation-title"></h2>
        <div class="day-tabs" id="day-tabs-container"></div>
        <table id="reservation-table">
            <thead>
                <tr>
                    <th>시간</th>
                    <th>예약 상태</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // 2. Firebase 초기화
    // =================================================================
    // 여기에 아까 Firebase 콘솔에서 복사한 firebaseConfig 코드를 붙여넣으세요!
    const firebaseConfig = {
        apiKey: "AIzaSyAYAWnTBTIa4aEsNFrKhRicSfLz9wv58Ew",
        authDomain: "bcs-parent-teacher-conference.firebaseapp.com",
        projectId: "bcs-parent-teacher-conference",
        storageBucket: "bcs-parent-teacher-conference.firebasestorage.app",
        messagingSenderId: "265252330101",
        appId: "1:265252330101:web:749b8ee8ab9de7d102363c"
    };
    // =================================================================

    // Firebase 앱 초기화 및 Firestore 인스턴스 생성
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 기존 DOM 요소 및 설정은 동일
    const classSelectionView = document.getElementById('class-selection-view');
    const reservationView = document.getElementById('reservation-view');
    const classButtonContainer = document.getElementById('class-buttons');
    const reservationTitle = document.getElementById('reservation-title');
    const dayTabsContainer = document.getElementById('day-tabs-container');
    const tableBody = document.querySelector('#reservation-table tbody');
    const backButton = document.getElementById('back-btn');

    const classNames = ["희락반", "자비반", "양선반", "충성반", "온유반", "은혜반"];
    const dayNames = ["월", "화", "수", "목", "금"];
    const startTime = 17 * 60;
    const endTime = 20 * 60;
    const interval = 30;
    
    let currentClass = '';
    let currentDay = '';

    // 초기 화면 설정 (변경 없음)
    function initializeClassSelection() {
        classNames.forEach(name => {
            const button = document.createElement('button');
            button.className = 'class-btn';
            button.textContent = name;
            button.addEventListener('click', () => showReservationView(name));
            classButtonContainer.appendChild(button);
        });
    }

    // 예약 화면 표시 (변경 없음)
    function showReservationView(className) {
        currentClass = className;
        currentDay = dayNames[0];
        classSelectionView.style.display = 'none';
        reservationView.style.display = 'block';
        reservationTitle.textContent = `${className} 상담 예약`;
        generateDayTabs();
        generateReservationTable();
    }
    
    // 뒤로 가기 (변경 없음)
    function showClassSelectionView() {
        reservationView.style.display = 'none';
        classSelectionView.style.display = 'block';
    }

    // 요일 탭 생성 (변경 없음)
    function generateDayTabs() {
        dayTabsContainer.innerHTML = '';
        dayNames.forEach(dayName => {
            const tab = document.createElement('button');
            tab.className = 'day-tab';
            tab.textContent = dayName;
            if (dayName === currentDay) tab.classList.add('active');
            tab.addEventListener('click', () => {
                currentDay = dayName;
                document.querySelectorAll('.day-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                generateReservationTable();
            });
            dayTabsContainer.appendChild(tab);
        });
    }

    // 3. 예약 테이블 생성 (Firebase 연동으로 로직 수정)
    async function generateReservationTable() {
        tableBody.innerHTML = '<tr><td colspan="2">예약 정보를 불러오는 중...</td></tr>';

        // Firestore에서 현재 반과 요일에 해당하는 예약 데이터를 가져옴
        const docId = `${currentClass}_${currentDay}`;
        const docRef = db.collection("reservations").doc(docId);
        const docSnap = await docRef.get();
        const reservationData = docSnap.exists ? docSnap.data() : {};

        tableBody.innerHTML = ''; // 로딩 메시지 제거

        for (let time = startTime; time < endTime; time += interval) {
            const row = document.createElement('tr');
            const timeCell = document.createElement('td');
            const statusCell = document.createElement('td');

            const startHour = String(Math.floor(time / 60)).padStart(2, '0');
            const startMinute = String(time % 60).padStart(2, '0');
            const timeString = `${startHour}:${startMinute}`;

            const endHour = String(Math.floor((time + interval) / 60)).padStart(2, '0');
            const endMinute = String((time + interval) % 60).padStart(2, '0');
            timeCell.textContent = `${timeString} - ${endHour}:${endMinute}`;

            const bookedName = reservationData[timeString];

            if (bookedName) {
                statusCell.textContent = `${bookedName} (예약 완료)`;
                statusCell.classList.add('booked');
            } else {
                statusCell.textContent = '예약하기';
                statusCell.classList.add('time-slot');
                statusCell.addEventListener('click', () => bookSlot(timeString));
            }

            row.appendChild(timeCell);
            row.appendChild(statusCell);
            tableBody.appendChild(row);
        }
    }

    // 4. 예약 기능 (Firebase 연동으로 로직 수정)
    async function bookSlot(timeString) {
        const name = prompt('예약자 성함을 입력해주세요:');
        if (name) {
            const docId = `${currentClass}_${currentDay}`;
            const docRef = db.collection("reservations").doc(docId);

            try {
                // Firestore에 데이터 저장. { merge: true }는 다른 시간대 예약을 덮어쓰지 않게 함
                await docRef.set({
                    [timeString]: name
                }, { merge: true });

                alert('예약이 완료되었습니다.');
                generateReservationTable(); // 예약 후 테이블을 다시 그려서 화면을 갱신
            } catch (error) {
                console.error("예약 중 오류 발생: ", error);
                alert("오류가 발생하여 예약에 실패했습니다. 다시 시도해주세요.");
            }
        }
    }

    // 이벤트 리스너 연결 및 초기화
    backButton.addEventListener('click', showClassSelectionView);
    initializeClassSelection();
});
</script>

</body>
</html>
